http {
    # 全局优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 30;
    types_hash_max_size 2048;
    
    # 压缩配置
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;

    # Brotli压缩
    brotli on;
    brotli_comp_level 6;
    brotli_types *;

    server {
        listen 443 ssl http2;
        server_name example.com;
        
        # SSL配置
        ssl_certificate /path/to/cert.pem;
        ssl_certificate_key /path/to/key.pem;
        
        # 缓存头
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|webp|avif)$ {
            expires 365d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # API缓存
        location /api/ {
            proxy_cache api_cache;
            proxy_cache_valid 200 5m;
            proxy_cache_use_stale error timeout updating;
            add_header X-Cache-Status $upstream_cache_status;
            proxy_pass http://backend;
        }

        # Service Worker安全策略
        location /sw.js {
            add_header Service-Worker-Allowed /;
            add_header Cache-Control "no-cache";
            proxy_pass http://frontend;
        }
    }
    
    # 上游服务
    upstream backend {
        zone backend 64k;
        server 10.0.0.1:8000;
        keepalive 8;
    }
    
    upstream frontend {
        server 10.0.0.2:3000;
    }
}
