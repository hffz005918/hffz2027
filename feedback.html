<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘˜å·¥åé¦ˆ - å®æ–¹çººç»‡</title>
    <style>
        :root {
            --primary-color: #1890ff;
            --secondary-color: #1a73e8;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #ff4d4f;
            --like-color: #ff6b6b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-light: #ffffff;
            --text-dark: #333333;
            --text-secondary: #666666;
            --border-radius: 12px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a8bad 0%, #4a6b8f 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-light);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .feedback-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
        }
        
        select, textarea, input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        select:focus, textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .char-count {
            text-align: right;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .submit-btn:hover {
            background: var(--secondary-color);
        }
        
        .submit-btn:active {
            transform: scale(0.98);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .back-link {
            display: block;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-light);
            text-decoration: none;
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        
        .back-link:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        .anonymous-notice {
            background: #f0f8ff;
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 4px;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-dark);
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 2rem;
            color: var(--success-color);
            background: #f6ffed;
            border-radius: 8px;
            border: 1px solid #b7eb8f;
            margin-bottom: 1.5rem;
        }
        
        .success-message h2 {
            margin-bottom: 1rem;
            color: var(--success-color);
        }
        
        .success-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .countdown {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .feedback-list {
            margin-top: 2rem;
        }

        .feedback-item {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .feedback-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .type-suggestion { background: #e6f7ff; color: var(--primary-color); }
        .type-problem { background: #fff7e6; color: var(--warning-color); }
        .type-complaint { background: #fff2f0; color: var(--error-color); }
        .type-other { background: #f6ffed; color: var(--success-color); }

        .feedback-time {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .feedback-content {
            margin-bottom: 1rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .feedback-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .feedback-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .feedback-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* ç‚¹èµæŒ‰é’®æ ·å¼ */
        .like-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 4px 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            color: #666;
            min-height: 32px;
        }

        .like-btn:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }

        .like-btn.liked {
            background: #fff0f0;
            border-color: var(--like-color);
            color: var(--like-color);
        }

        .like-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .like-btn.liked .like-icon {
            animation: like-pop 0.3s;
        }

        @keyframes like-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .like-icon {
            font-size: 1rem;
        }

        .like-count {
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        /* è¯„è®ºæŒ‰é’®æ ·å¼ */
        .comment-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 4px 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            color: #666;
            min-height: 32px;
            text-decoration: none;
        }

        .comment-btn:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }

        /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
            background: #fafafa;
        }

        .image-upload-area:hover {
            border-color: var(--primary-color);
            background: #f0f8ff;
        }

        .image-upload-area.dragover {
            border-color: var(--primary-color);
            background: #e6f7ff;
        }

        .image-upload-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .image-upload-text {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .image-upload-hint {
            font-size: 0.85rem;
            color: #999;
        }

        #imageInput {
            display: none;
        }

        /* å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--error-color);
            font-size: 14px;
            transition: all 0.3s;
        }

        .image-preview-remove:hover {
            background: #fff;
            transform: scale(1.1);
        }

        /* ä¸Šä¼ è¿›åº¦æ¡ */
        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* å›¾ç‰‡å±•ç¤ºåŒºåŸŸ */
        .feedback-images {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .feedback-images-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .feedback-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .feedback-image-item {
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #eee;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .feedback-image-item:hover {
            transform: scale(1.02);
            border-color: var(--primary-color);
        }

        .feedback-image-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        /* å›¾ç‰‡æ¨¡æ€æ¡† */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .image-modal.active {
            display: flex;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        /* è¯„è®ºåŒºåŸŸæ ·å¼ */
        .comments-section {
            margin-top: 1.5rem;
            border-top: 1px solid #eee;
            padding-top: 1.5rem;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .comments-header h3 {
            font-size: 1rem;
            color: var(--text-dark);
        }

        .comment-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .comments-list {
            margin-bottom: 1.5rem;
        }

        .comment-item {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid #ddd;
            position: relative;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .comment-author {
            font-weight: bold;
            color: var(--text-dark);
        }

        .comment-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .comment-content {
            line-height: 1.5;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .comment-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 0.5rem;
        }

        /* è¯„è®ºç‚¹èµæŒ‰é’® */
        .comment-like-btn {
            background: transparent;
            border: 1px solid #ddd;
            border-radius: 16px;
            padding: 2px 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.75rem;
            color: #666;
        }

        .comment-like-btn:hover {
            border-color: #ccc;
        }

        .comment-like-btn.liked {
            background: #fff0f0;
            border-color: var(--like-color);
            color: var(--like-color);
        }

        .comment-like-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .comment-like-icon {
            font-size: 0.85rem;
        }

        .comment-like-count {
            font-weight: bold;
            min-width: 16px;
            text-align: center;
        }

        .no-comments {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
            font-style: italic;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .add-comment-form {
            margin-top: 1rem;
        }

        .comment-input-group {
            margin-bottom: 1rem;
        }

        .comment-input-group label {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .comment-input {
            padding: 10px;
            font-size: 0.9rem;
            min-height: 80px;
        }

        .add-comment-btn {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .add-comment-btn:hover {
            background: var(--secondary-color);
        }

        .add-comment-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .view-comments-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
            padding: 0;
        }

        .view-comments-btn:hover {
            color: var(--secondary-color);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .error-message {
            background: #fff2f0;
            border-left: 4px solid var(--error-color);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            color: var(--error-color);
            display: none;
        }

        .server-status {
            background: #f0f8ff;
            border-left: 4px solid var(--primary-color);
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            display: none;
        }

        .server-status.connected {
            background: #f6ffed;
            border-left-color: var(--success-color);
        }

        .server-status.error {
            background: #fff2f0;
            border-left-color: var(--error-color);
        }

        .server-status.warning {
            background: #fff7e6;
            border-left-color: var(--warning-color);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .feedback-card {
                padding: 1.5rem;
            }
            
            .header h1 {
                font-size: 1.7rem;
            }
            
            .feedback-stats {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .feedback-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .image-preview-container {
                justify-content: center;
            }
            
            .feedback-images-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .feedback-card {
                padding: 1.2rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .feedback-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .image-upload-area {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å‘˜å·¥åé¦ˆç³»ç»Ÿ</h1>
            <p>å®æ–¹çººç»‡ - æ‚¨çš„æ„è§å¯¹æˆ‘ä»¬éå¸¸é‡è¦</p>
        </div>
        
        <div class="feedback-card">
            <!-- æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º -->
            <div class="server-status" id="serverStatus">
                æ­£åœ¨è¿æ¥æœåŠ¡å™¨...
            </div>

            <div class="anonymous-notice">
                <strong>æ¸©é¦¨æç¤ºï¼š</strong>æ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬è‡³å…³é‡è¦ï¼Œå®ƒå°†ç›´æ¥å¸®åŠ©æˆ‘ä»¬å€¾å¬å¿ƒå£°ã€å‘ç°é—®é¢˜ï¼Œå¹¶ä¸ºæ‚¨å’Œæ‰€æœ‰ä¼™ä¼´åˆ›é€ ä¸€ä¸ªæ›´èˆ’é€‚ã€æ›´é¡ºç•…çš„å·¥ä½œç¯å¢ƒã€‚æ„Ÿè°¢æ‚¨çš„æ”¯æŒä¸åŒè¡Œï¼
            </div>

            <div class="error-message" id="errorMessage"></div>
            
            <form id="feedbackForm">
                <div class="form-group">
                    <label for="employeeName">æ‚¨çš„ç§°å‘¼ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="employeeName" placeholder="å¯ä»¥å¡«å†™å§“åæˆ–æ˜µç§°">
                </div>

                <div class="form-group">
                    <label for="feedbackType">åé¦ˆç±»å‹ <span style="color: var(--error-color);">*</span></label>
                    <select id="feedbackType" required>
                        <option value="">è¯·é€‰æ‹©åé¦ˆç±»å‹</option>
                        <option value="suggestion">æ„è§å»ºè®®</option>
                        <option value="problem">é—®é¢˜åé¦ˆ</option>
                        <option value="complaint">æŠ•è¯‰ä¸¾æŠ¥</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="feedbackContent">åé¦ˆå†…å®¹ <span style="color: var(--error-color);">*</span></label>
                    <textarea 
                        id="feedbackContent" 
                        placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„åé¦ˆå†…å®¹..." 
                        maxlength="1000"
                        required
                    ></textarea>
                    <div class="char-count">
                        <span id="charCount">0</span>/1000
                    </div>
                </div>
                
                <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                <div class="form-group">
                    <label>ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                    <div class="image-upload-area" id="imageUploadArea">
                        <div class="image-upload-icon">ğŸ“·</div>
                        <div class="image-upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                        <div class="image-upload-hint">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œæ¯å¼ å›¾ç‰‡æœ€å¤§ 5MB</div>
                        <input type="file" id="imageInput" accept="image/*" multiple>
                    </div>
                    
                    <!-- å›¾ç‰‡é¢„è§ˆå®¹å™¨ -->
                    <div class="image-preview-container" id="imagePreviewContainer"></div>
                    
                    <!-- ä¸Šä¼ è¿›åº¦ -->
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">å‡†å¤‡ä¸Šä¼ ...</div>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">æäº¤åé¦ˆ</button>
            </form>
            
            <div class="success-message" id="successMessage">
                <div class="success-icon">âœ…</div>
                <h2>æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼</h2>
                <p>æ‚¨çš„æ„è§å·²æˆåŠŸæäº¤ï¼Œæˆ‘ä»¬ä¼šè®¤çœŸè€ƒè™‘å¹¶å°½å¿«å¤„ç†ã€‚</p>
                <p>åé¦ˆID: <strong><span id="feedbackId"></span></strong></p>
                <p>çŠ¶æ€: <span id="feedbackStatus"></span></p>
                <p>é¡µé¢å°†åœ¨ <span class="countdown" id="countdown">5</span> ç§’åè‡ªåŠ¨åˆ·æ–°</p>
                <button onclick="location.reload()" style="margin-top: 1rem; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ç«‹å³åˆ·æ–°
                </button>
            </div>
        </div>

        <!-- åé¦ˆåˆ—è¡¨ -->
        <div class="feedback-card">
            <h2 style="margin-bottom: 1rem;">æœ€æ–°åé¦ˆ</h2>
            <div id="feedbacksList">
                <div class="loading">æ­£åœ¨åŠ è½½æœ€æ–°åé¦ˆ...</div>
            </div>
        </div>
        
        <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
        <div class="image-modal" id="imageModal">
            <button class="image-modal-close" onclick="closeImageModal()">Ã—</button>
            <div class="image-modal-content">
                <img id="modalImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
            </div>
        </div>
        
        <a href="index.html" class="back-link">è¿”å›é¦–é¡µ</a>
        <a href="admin-feedback.html" class="back-link" style="margin-top: 0.5rem;">ç®¡ç†å‘˜å…¥å£</a>
    </div>

    <script src="jsonbin-storage.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('å‘˜å·¥åé¦ˆé¡µé¢åˆå§‹åŒ–');
            
            // å…¨å±€ç”¨æˆ·IDï¼ˆç”¨äºç‚¹èµè·Ÿè¸ªï¼‰
            let currentUserId = getOrCreateUserId();
            
            // å­˜å‚¨é€‰æ‹©çš„å›¾ç‰‡æ–‡ä»¶
            let selectedImages = [];
            
            // DOM å…ƒç´ 
            const feedbackForm = document.getElementById('feedbackForm');
            const feedbackContent = document.getElementById('feedbackContent');
            const charCount = document.getElementById('charCount');
            const submitBtn = document.getElementById('submitBtn');
            const successMessage = document.getElementById('successMessage');
            const countdownElement = document.getElementById('countdown');
            const feedbackIdElement = document.getElementById('feedbackId');
            const feedbackStatusElement = document.getElementById('feedbackStatus');
            const feedbacksList = document.getElementById('feedbacksList');
            const errorMessage = document.getElementById('errorMessage');
            const serverStatus = document.getElementById('serverStatus');
            const imageInput = document.getElementById('imageInput');
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            // åˆå§‹åŒ–
            initializePage();

            /**
             * è·å–æˆ–åˆ›å»ºç”¨æˆ·ID
             */
            function getOrCreateUserId() {
                let userId = localStorage.getItem('feedback_user_id');
                if (!userId) {
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('feedback_user_id', userId);
                }
                return userId;
            }

            /**
             * é¡µé¢åˆå§‹åŒ–
             */
            async function initializePage() {
                // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
                await testServerConnection();
                
                // åŠ è½½åé¦ˆåˆ—è¡¨
                await loadFeedbacks();
                
                // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
                setupEventListeners();
               // åˆå§‹åŒ–å›¾ç‰‡è®¡æ•°æ˜¾ç¤º
                updateImageCount();
         }

            /**
             * æµ‹è¯•æœåŠ¡å™¨è¿æ¥
             */
            async function testServerConnection() {
                try {
                    const result = await jsonBinStorage.testConnection();
                    
                    serverStatus.textContent = result.message;
                    serverStatus.style.display = 'block';
                    
                    if (result.connected) {
                        serverStatus.className = 'server-status connected';
                        console.log('æœåŠ¡å™¨è¿æ¥çŠ¶æ€:', result);
                    } else if (result.usingFallback) {
                        serverStatus.className = 'server-status warning';
                    } else {
                        serverStatus.className = 'server-status error';
                    }
                } catch (error) {
                    console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                    serverStatus.textContent = 'æœåŠ¡å™¨è¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•';
                    serverStatus.className = 'server-status error';
                    serverStatus.style.display = 'block';
                }
            }

            /**
             * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
             */
            function setupEventListeners() {
                // å­—ç¬¦è®¡æ•°
                feedbackContent.addEventListener('input', function() {
                    const length = this.value.length;
                    charCount.textContent = length;
                    
                    if (length > 900) {
                        charCount.style.color = '#ff4d4f';
                    } else {
                        charCount.style.color = '';
                    }
                });

                // è¡¨å•éªŒè¯
                feedbackForm.addEventListener('input', function() {
                    const typeSelected = document.getElementById('feedbackType').value !== '';
                    const contentFilled = feedbackContent.value.trim().length > 0;
                    
                    submitBtn.disabled = !(typeSelected && contentFilled);
                });

                // è¡¨å•æäº¤
                feedbackForm.addEventListener('submit', handleFormSubmit);

                // å›¾ç‰‡ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
                imageUploadArea.addEventListener('click', function() {
                    imageInput.click();
                });

                // å›¾ç‰‡é€‰æ‹©äº‹ä»¶
                imageInput.addEventListener('change', handleImageSelect);

                // æ‹–æ‹½ä¸Šä¼ äº‹ä»¶
                setupDragAndDrop();
            }

            /**
             * è®¾ç½®æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
             */
            function setupDragAndDrop() {
                // é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    imageUploadArea.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });

                // é«˜äº®æ˜¾ç¤ºæ‹–æ‹½åŒºåŸŸ
                ['dragenter', 'dragover'].forEach(eventName => {
                    imageUploadArea.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    imageUploadArea.addEventListener(eventName, unhighlight, false);
                });

                // å¤„ç†æ–‡ä»¶æ”¾ç½®
                imageUploadArea.addEventListener('drop', handleDrop, false);

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                function highlight() {
                    imageUploadArea.classList.add('dragover');
                }

                function unhighlight() {
                    imageUploadArea.classList.remove('dragover');
                }

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    handleImageFiles(files);
                }
            }

            /**
             * å¤„ç†å›¾ç‰‡é€‰æ‹©
             */
            function handleImageSelect(e) {
                const files = e.target.files;
                handleImageFiles(files);
            }

            /**
             * å¤„ç†å›¾ç‰‡æ–‡ä»¶
             */
            function handleImageFiles(files) {
                if (!files || files.length === 0) return;
                
                // é™åˆ¶æœ€å¤š5å¼ å›¾ç‰‡
                const maxImages = 5;
                const remainingSlots = maxImages - selectedImages.length;
                
                if (files.length > remainingSlots) {
                    showError(`æœ€å¤šåªèƒ½ä¸Šä¼  ${maxImages} å¼ å›¾ç‰‡ï¼Œå·²é€‰æ‹© ${selectedImages.length} å¼ `);
                    return;
                }
                
                // éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.type.startsWith('image/')) {
                        showError(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯å›¾ç‰‡æ ¼å¼ï¼Œå·²è·³è¿‡`);
                        continue;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
                    if (file.size > 5 * 1024 * 1024) {
                        showError(`å›¾ç‰‡ "${file.name}" å¤ªå¤§ï¼ˆè¶…è¿‡5MBï¼‰ï¼Œå·²è·³è¿‡`);
                        continue;
                    }
                    
                    // æ·»åŠ åˆ°é€‰ä¸­å›¾ç‰‡æ•°ç»„
                    selectedImages.push(file);
                    
                    // åˆ›å»ºé¢„è§ˆ
                    createImagePreview(file);
                }
                
                // é‡ç½®æ–‡ä»¶è¾“å…¥
                imageInput.value = '';
                
                console.log('å·²é€‰æ‹©å›¾ç‰‡:', selectedImages);
            }

            /**
             * åˆ›å»ºå›¾ç‰‡é¢„è§ˆ
             */
            function createImagePreview(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = file.name;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'image-preview-remove';
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.title = 'ç§»é™¤å›¾ç‰‡';
                    
                    // ç‚¹å‡»ç§»é™¤æŒ‰é’®
                    removeBtn.addEventListener('click', function() {
                        removeImagePreview(file, previewItem);
                    });
                    
                    // ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹å¤§å›¾
                    img.addEventListener('click', function() {
                        openImageModal(e.target.result);
                    });
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    imagePreviewContainer.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
            }

            /**
             * ç§»é™¤å›¾ç‰‡é¢„è§ˆ
             */
            function removeImagePreview(file, previewElement) {
                // ä»æ•°ç»„ä¸­ç§»é™¤
                selectedImages = selectedImages.filter(f => f !== file);
                
                // ä»DOMä¸­ç§»é™¤
                previewElement.remove();
                
                console.log('å·²ç§»é™¤å›¾ç‰‡ï¼Œå‰©ä½™:', selectedImages);
            }

            /**
             * æ‰“å¼€å›¾ç‰‡æ¨¡æ€æ¡†
             */
            function openImageModal(imageSrc) {
                modalImage.src = imageSrc;
                imageModal.classList.add('active');
                
                // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
                imageModal.addEventListener('click', function(e) {
                    if (e.target === imageModal) {
                        closeImageModal();
                    }
                });
                
                // ESCé”®å…³é—­
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closeImageModal();
                    }
                });
            }

            /**
             * å…³é—­å›¾ç‰‡æ¨¡æ€æ¡†
             */
            function closeImageModal() {
                imageModal.classList.remove('active');
                modalImage.src = '';
            }

            /**
             * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
             */
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }

            /**
             * æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
             */
            function showSuccess(feedbackId, status) {
                // éšè—è¡¨å•ï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                feedbackForm.style.display = 'none';
                successMessage.style.display = 'block';
                
                // æ˜¾ç¤ºåé¦ˆä¿¡æ¯
                if (feedbackIdElement) {
                    feedbackIdElement.textContent = feedbackId;
                }
                
                if (feedbackStatusElement) {
                    feedbackStatusElement.textContent = status || 'å·²æäº¤ï¼Œå¾…å¤„ç†';
                }
                
                // å€’è®¡æ—¶åˆ·æ–°
                let countdown = 5;
                countdownElement.textContent = countdown;
                
                const countdownInterval = setInterval(function() {
                    countdown--;
                    countdownElement.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        location.reload();
                    }
                }, 1000);
            }

            /**
             * åŠ è½½åé¦ˆåˆ—è¡¨
             */
            async function loadFeedbacks() {
                try {
                    const feedbacks = await jsonBinStorage.getFeedbacks();
                    
                    // å¤„ç†ç‚¹èµçŠ¶æ€
                    const processedFeedbacks = feedbacks.map(feedback => {
                        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹èµäº†è¯¥åé¦ˆ
                        feedback.userLiked = feedback.likes && feedback.likes.users ? 
                            feedback.likes.users.includes(currentUserId) : false;
                        
                        // å¤„ç†è¯„è®ºçš„ç‚¹èµçŠ¶æ€
                        if (feedback.comments) {
                            feedback.comments.forEach(comment => {
                                comment.userLiked = comment.likes && comment.likes.users ?
                                    comment.likes.users.includes(currentUserId) : false;
                            });
                        }
                        
                        return feedback;
                    });
                    
                    displayFeedbacks(processedFeedbacks);
                } catch (error) {
                    console.error('åŠ è½½åé¦ˆåˆ—è¡¨å¤±è´¥:', error);
                    feedbacksList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--error-color);">
                            åŠ è½½å¤±è´¥: ${error.message}<br>
                            <button onclick="location.reload()" style="margin-top: 1rem; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                é‡è¯•åŠ è½½
                            </button>
                        </div>
                    `;
                }
            }

            /**
             * æ˜¾ç¤ºåé¦ˆåˆ—è¡¨
             */
            function displayFeedbacks(feedbacks) {
                if (feedbacks.length === 0) {
                    feedbacksList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            æš‚æ— åé¦ˆï¼Œæˆä¸ºç¬¬ä¸€ä¸ªå‘è¨€çš„äººå§ï¼
                        </div>
                    `;
                    return;
                }

                // æŒ‰æ—¶é—´å€’åºæ’åºï¼Œåªæ˜¾ç¤ºæœ€æ–°çš„5æ¡
                feedbacks.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const recentFeedbacks = feedbacks.slice(0, 5);
                
                let html = '';
                recentFeedbacks.forEach(feedback => {
                    const typeClass = {
                        'suggestion': 'type-suggestion',
                        'problem': 'type-problem',
                        'complaint': 'type-complaint',
                        'other': 'type-other'
                    }[feedback.type] || 'type-other';
                    
                    const typeText = {
                        'suggestion': 'æ„è§å»ºè®®',
                        'problem': 'é—®é¢˜åé¦ˆ',
                        'complaint': 'æŠ•è¯‰ä¸¾æŠ¥',
                        'other': 'å…¶ä»–'
                    }[feedback.type] || 'å…¶ä»–';
                    
                    const date = new Date(feedback.timestamp);
                    const timeString = date.toLocaleString('zh-CN');
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰è¯„è®º
                    const hasComments = feedback.comments && feedback.comments.length > 0;
                    const commentCount = hasComments ? feedback.comments.length : 0;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡
                    const hasImages = feedback.images && feedback.images.length > 0;
                    
                    // è·å–ç‚¹èµæ•°
                    const likesCount = feedback.likes ? feedback.likes.count : 0;
                    const isLiked = feedback.userLiked || false;
                    
                    html += `
                        <div class="feedback-item" data-feedback-id="${feedback.id}">
                            <div class="feedback-header">
                                <div>
                                    <span class="feedback-type ${typeClass}">${typeText}</span>
                                    <strong style="margin-left: 8px;">${feedback.employeeName || 'åŒ¿ååŒäº‹'}</strong>
                                </div>
                                <div class="feedback-time">${timeString}</div>
                            </div>
                            <div class="feedback-content">${feedback.content}</div>
                            
                            <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
                            ${hasImages ? renderFeedbackImages(feedback.images) : ''}
                            
                            <div class="feedback-stats">
                                <div class="feedback-info">
                                    <span>çŠ¶æ€: ${feedback.status === 'processed' ? 'âœ… å·²å¤„ç†' : 'â³ å¾…å¤„ç†'}</span>
                                    <span>åé¦ˆID: ${feedback.id || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="feedback-actions">
                                    <button class="like-btn ${isLiked ? 'liked' : ''}" 
                                            onclick="toggleFeedbackLike('${feedback.id}', this)"
                                            data-feedback-id="${feedback.id}"
                                            title="${isLiked ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ'}">
                                        <span class="like-icon">${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                                        <span class="like-count">${likesCount}</span>
                                    </button>
                                    <button class="comment-btn" onclick="toggleComments('${feedback.id}', this)">
                                        ${commentCount > 0 ? `ğŸ’¬ è¯„è®º(${commentCount})` : 'ğŸ’¬ å‘è¡¨è¯„è®º'}
                                    </button>
                                </div>
                            </div>
                            
                            <!-- è¯„è®ºåŒºåŸŸ (åˆå§‹éšè—) -->
                            <div class="comments-section" id="comments-${feedback.id}" style="display: none;">
                                <div class="comments-header">
                                    <h3>è¯„è®º</h3>
                                    <span class="comment-count">${commentCount} æ¡è¯„è®º</span>
                                </div>
                                
                                <div class="comments-list" id="comments-list-${feedback.id}">
                                    ${hasComments ? renderComments(feedback.comments, feedback.id) : `
                                        <div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€ä¸ªè¯„è®ºå§ï¼</div>
                                    `}
                                </div>
                                
                                <div class="add-comment-form">
                                    <div class="comment-input-group">
                                        <label for="comment-author-${feedback.id}">æ‚¨çš„ç§°å‘¼ï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" id="comment-author-${feedback.id}" placeholder="å§“åæˆ–æ˜µç§°">
                                    </div>
                                    <div class="comment-input-group">
                                        <label for="comment-content-${feedback.id}">è¯„è®ºå†…å®¹</label>
                                        <textarea 
                                            id="comment-content-${feedback.id}" 
                                            class="comment-input" 
                                            placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„è®º..." 
                                            maxlength="500"
                                            required
                                        ></textarea>
                                    </div>
                                    <button 
                                        type="button" 
                                        class="add-comment-btn" 
                                        id="add-comment-btn-${feedback.id}"
                                        onclick="addComment('${feedback.id}')"
                                    >
                                        å‘è¡¨è¯„è®º
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                feedbacksList.innerHTML = html;
            }

            /**
             * æ¸²æŸ“åé¦ˆå›¾ç‰‡
             */
            function renderFeedbackImages(images) {
                if (!images || images.length === 0) return '';
                
                let html = `
                    <div class="feedback-images">
                        <div class="feedback-images-title">ğŸ“· ä¸Šä¼ å›¾ç‰‡ (${images.length})</div>
                        <div class="feedback-images-grid">
                `;
                
                images.forEach((image, index) => {
                    html += `
                        <div class="feedback-image-item" onclick="openImageModal('${image.url}')">
                            <img src="${image.thumbnail || image.url}" alt="åé¦ˆå›¾ç‰‡ ${index + 1}">
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                return html;
            }

            /**
             * æ¸²æŸ“è¯„è®ºåˆ—è¡¨
             */
            function renderComments(comments, feedbackId) {
                if (!comments || comments.length === 0) {
                    return '<div class="no-comments">æš‚æ— è¯„è®º</div>';
                }
                
                // æŒ‰æ—¶é—´å€’åºæ’åº
                comments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let html = '';
                comments.forEach(comment => {
                    const date = new Date(comment.timestamp);
                    const timeString = date.toLocaleString('zh-CN');
                    const commentLikesCount = comment.likes ? comment.likes.count : 0;
                    const isLiked = comment.userLiked || false;
                    
                    html += `
                        <div class="comment-item" data-comment-id="${comment.id}">
                            <div class="comment-header">
                                <span class="comment-author">${comment.author || 'åŒ¿ååŒäº‹'}</span>
                                <span class="comment-time">${timeString}</span>
                            </div>
                            <div class="comment-content">${comment.content}</div>
                            <div class="comment-actions">
                                <button class="comment-like-btn ${isLiked ? 'liked' : ''}" 
                                        onclick="toggleCommentLike('${feedbackId}', '${comment.id}', this)"
                                        data-comment-id="${comment.id}"
                                        title="${isLiked ? 'å–æ¶ˆç‚¹èµ' : 'ç‚¹èµ'}">
                                    <span class="comment-like-icon">${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                                    <span class="comment-like-count">${commentLikesCount}</span>
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }

            /**
             * å¤„ç†è¡¨å•æäº¤
             */
            async function handleFormSubmit(e) {
                e.preventDefault();
                
                console.log('å¼€å§‹æäº¤åé¦ˆ...');
                
                // éšè—ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
                errorMessage.style.display = 'none';
                
                // è¡¨å•éªŒè¯
                const typeSelected = document.getElementById('feedbackType').value !== '';
                const contentFilled = feedbackContent.value.trim().length > 0;
                
                if (!typeSelected) {
                    showError('è¯·é€‰æ‹©åé¦ˆç±»å‹');
                    return;
                }
                
                if (!contentFilled) {
                    showError('è¯·å¡«å†™åé¦ˆå†…å®¹');
                    return;
                }
                
                if (contentFilled && feedbackContent.value.trim().length < 5) {
                    showError('åé¦ˆå†…å®¹è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦');
                    return;
                }
                
                // æ£€æŸ¥å›¾ç‰‡æ•°é‡
                if (selectedImages.length > 5) {
                    showError('æœ€å¤šåªèƒ½ä¸Šä¼ 5å¼ å›¾ç‰‡');
                    return;
                }
                
                // ç¦ç”¨æäº¤æŒ‰é’®
                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';
                
                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                uploadProgress.classList.add('active');
                progressText.textContent = 'å‡†å¤‡ä¸Šä¼ ...';
                
                try {
                    // å‡†å¤‡åé¦ˆæ•°æ®
                    const feedbackData = {
                        employeeName: document.getElementById('employeeName').value.trim(),
                        type: document.getElementById('feedbackType').value,
                        content: feedbackContent.value.trim(),
                        imageFiles: selectedImages // æ·»åŠ å›¾ç‰‡æ–‡ä»¶
                    };
                    
                    console.log('æäº¤åé¦ˆæ•°æ®:', feedbackData);
                    
                    // ä¿å­˜åˆ°äº‘ç«¯
                    const result = await jsonBinStorage.saveFeedback(feedbackData);
                    
                    console.log('ä¿å­˜ç»“æœ:', result);
                    
                    if (result.success) {
                        console.log('âœ… åé¦ˆæäº¤æˆåŠŸï¼ŒID:', result.id);
                        
                        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                        progressFill.style.width = '100%';
                        progressText.textContent = 'ä¸Šä¼ å®Œæˆï¼';
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        setTimeout(() => {
                            showSuccess(result.id, 'å·²æäº¤');
                            
                            // é‡æ–°åŠ è½½åé¦ˆåˆ—è¡¨
                            setTimeout(() => {
                                loadFeedbacks();
                            }, 1000);
                        }, 1000);
                    } else {
                        throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                    }
                } catch (error) {
                    console.error('âŒ æäº¤å¤±è´¥:', error);
                    showError('æäº¤å¤±è´¥: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'æäº¤åé¦ˆ';
                    uploadProgress.classList.remove('active');
                }
            }

            /**
             * åˆ‡æ¢è¯„è®ºæ˜¾ç¤º/éšè—
             */
            window.toggleComments = function(feedbackId, button) {
                const commentsSection = document.getElementById(`comments-${feedbackId}`);
                if (!commentsSection) return;
                
                if (commentsSection.style.display === 'none') {
                    commentsSection.style.display = 'block';
                    if (button) button.textContent = 'æ”¶èµ·è¯„è®º';
                } else {
                    commentsSection.style.display = 'none';
                    if (button) {
                        const commentCount = commentsSection.querySelectorAll('.comment-item').length;
                        button.textContent = commentCount > 0 ? `ğŸ’¬ è¯„è®º(${commentCount})` : 'ğŸ’¬ å‘è¡¨è¯„è®º';
                    }
                }
            };

            /**
             * æ·»åŠ è¯„è®º
             */
            window.addComment = async function(feedbackId) {
                const authorInput = document.getElementById(`comment-author-${feedbackId}`);
                const contentInput = document.getElementById(`comment-content-${feedbackId}`);
                const addCommentBtn = document.getElementById(`add-comment-btn-${feedbackId}`);
                
                // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
                if (!addCommentBtn) {
                    console.error('è¯„è®ºæŒ‰é’®æœªæ‰¾åˆ°:', `add-comment-btn-${feedbackId}`);
                    alert('è¯„è®ºåŠŸèƒ½å‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                
                const author = authorInput ? authorInput.value.trim() : '';
                const content = contentInput ? contentInput.value.trim() : '';
                
                // éªŒè¯
                if (!content) {
                    alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                    if (contentInput) contentInput.focus();
                    return;
                }
                
                if (content.length < 5) {
                    alert('è¯„è®ºå†…å®¹è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦');
                    if (contentInput) contentInput.focus();
                    return;
                }
                
                try {
                    // ç¦ç”¨æäº¤æŒ‰é’®
                    addCommentBtn.disabled = true;
                    addCommentBtn.textContent = 'æäº¤ä¸­...';
                    
                    // åˆ›å»ºè¯„è®ºæ•°æ®
                    const commentData = {
                        author: author || 'åŒ¿ååŒäº‹',
                        content: content,
                        timestamp: new Date().toISOString()
                    };
                    
                    console.log('æ·»åŠ è¯„è®º:', commentData);
                    
                    // ä¿å­˜è¯„è®ºåˆ°äº‘ç«¯
                    const result = await jsonBinStorage.addComment(feedbackId, commentData);
                    
                    if (result.success) {
                        console.log('âœ… è¯„è®ºæ·»åŠ æˆåŠŸ');
                        
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        if (authorInput) authorInput.value = '';
                        if (contentInput) contentInput.value = '';
                        
                        // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                        const commentsList = document.getElementById(`comments-list-${feedbackId}`);
                        if (commentsList) {
                            // é‡æ–°åŠ è½½æ•´ä¸ªåé¦ˆåˆ—è¡¨ä»¥è·å–æœ€æ–°æ•°æ®
                            await loadFeedbacks();
                            
                            // å±•å¼€è¯„è®ºåŒºåŸŸ
                            const commentsSection = document.getElementById(`comments-${feedbackId}`);
                            if (commentsSection) {
                                commentsSection.style.display = 'block';
                            }
                            
                            // æ›´æ–°è¯„è®ºæŒ‰é’®æ–‡æœ¬
                            const commentBtn = document.querySelector(`[data-feedback-id="${feedbackId}"] .comment-btn`);
                            if (commentBtn) {
                                const newCount = result.updatedFeedback.comments ? result.updatedFeedback.comments.length : 0;
                                commentBtn.textContent = newCount > 0 ? `ğŸ’¬ è¯„è®º(${newCount})` : 'ğŸ’¬ å‘è¡¨è¯„è®º';
                            }
                        }
                    } else {
                        throw new Error(result.message || 'æ·»åŠ è¯„è®ºå¤±è´¥');
                    }
                } catch (error) {
                    console.error('âŒ æ·»åŠ è¯„è®ºå¤±è´¥:', error);
                    alert('æ·»åŠ è¯„è®ºå¤±è´¥: ' + error.message);
                } finally {
                    // æ¢å¤æäº¤æŒ‰é’®
                    if (addCommentBtn) {
                        addCommentBtn.disabled = false;
                        addCommentBtn.textContent = 'å‘è¡¨è¯„è®º';
                    }
                }
            };

            /**
             * åˆ‡æ¢åé¦ˆç‚¹èµçŠ¶æ€
             */
            window.toggleFeedbackLike = async function(feedbackId, button) {
                if (!button) return;
                
                // é˜²æ­¢é‡å¤ç‚¹å‡»
                if (button.disabled) return;
                button.disabled = true;
                
                const likeIcon = button.querySelector('.like-icon');
                const likeCountSpan = button.querySelector('.like-count');
                
                try {
                    // è°ƒç”¨ç‚¹èµAPI
                    const result = await jsonBinStorage.toggleLike(feedbackId, currentUserId);
                    
                    if (result.success) {
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        if (result.action === 'liked') {
                            button.classList.add('liked');
                            likeIcon.textContent = 'â¤ï¸';
                        } else {
                            button.classList.remove('liked');
                            likeIcon.textContent = 'ğŸ¤';
                        }
                        
                        // æ›´æ–°ç‚¹èµæ•°
                        if (likeCountSpan) {
                            likeCountSpan.textContent = result.likesCount;
                        }
                        
                        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                        button.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            button.style.transform = 'scale(1)';
                        }, 100);
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                } finally {
                    button.disabled = false;
                }
            };

            /**
             * åˆ‡æ¢è¯„è®ºç‚¹èµçŠ¶æ€
             */
            window.toggleCommentLike = async function(feedbackId, commentId, button) {
                if (!button) return;
                
                // é˜²æ­¢é‡å¤ç‚¹å‡»
                if (button.disabled) return;
                button.disabled = true;
                
                const likeIcon = button.querySelector('.comment-like-icon');
                const likeCountSpan = button.querySelector('.comment-like-count');
                
                try {
                    // è°ƒç”¨è¯„è®ºç‚¹èµAPI
                    const result = await jsonBinStorage.toggleCommentLike(feedbackId, commentId, currentUserId);
                    
                    if (result.success) {
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        if (result.action === 'liked') {
                            button.classList.add('liked');
                            likeIcon.textContent = 'â¤ï¸';
                        } else {
                            button.classList.remove('liked');
                            likeIcon.textContent = 'ğŸ¤';
                        }
                        
                        // æ›´æ–°ç‚¹èµæ•°
                        if (likeCountSpan) {
                            likeCountSpan.textContent = result.likesCount;
                        }
                        
                        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                        button.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            button.style.transform = 'scale(1)';
                        }, 100);
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    console.error('è¯„è®ºç‚¹èµæ“ä½œå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                } finally {
                    button.disabled = false;
                }
            };

            /**
             * æ‰“å¼€å›¾ç‰‡æ¨¡æ€æ¡†
             */
            window.openImageModal = function(imageSrc) {
                modalImage.src = imageSrc;
                imageModal.classList.add('active');
                
                // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
                imageModal.addEventListener('click', function(e) {
                    if (e.target === imageModal) {
                        closeImageModal();
                    }
                });
                
                // ESCé”®å…³é—­
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closeImageModal();
                    }
                });
            };
        });
    </script>
</body>
</html>
