<!DOCTYPE html>
<html lang="zh-CN" data-network="unknown">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 多级缓存控制 -->
    <meta http-equiv="Cache-Control" content="max-age=604800, must-revalidate">
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    <!-- 移动端专属优化 -->
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/app.webmanifest">
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="critical.css" as="style">
    <link rel="preload" href="critical.js" as="script">
    <link rel="preload" href="bg.avif" as="image" type="image/avif">
    <link rel="preload" href="bg.webp" as="image" type="image/webp">
    
    <!-- DNS预解析 -->
    <link rel="dns-prefetch" href="//static.example.com">
    <link rel="dns-prefetch" href="//api.example.com">
    
    <title>员工服务系统</title>
    
    <!-- 关键CSS -->
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "Microsoft YaHei", system-ui;
            height: 100vh;
            position: relative;
            -webkit-touch-callout: none;
            text-size-adjust: 100%;
            overflow-x: hidden;
        }

        .background {
            position: fixed;
            width: 100vw;
            height: 100vh;
            background: #6a8bad;
            z-index: -1;
            transform: translateZ(0);
        }

        /* 移动端优先布局 */
        .content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            justify-content: center;
        }

        /* 卡片样式 */
        .nav-card {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            break-inside: avoid;
        }

        @media (hover: hover) {
            .nav-card:hover {
                transform: translateY(-3px);
            }
        }

        /* 加载状态 */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: none;
            place-items: center;
            z-index: 1000;
        }
    </style>
    
    <!-- 非关键CSS -->
    <link rel="stylesheet" href="styles.css" media="print" onload="this.media='all'">
</head>

<body>
    <!-- 加载指示器 -->
    <div class="loader" id="loader">加载中...</div>
    
    <!-- 更新提示 -->
    <div id="updateNotice" class="update-notice" hidden>
        新版本可用，<button onclick="location.reload()">点击刷新</button>
    </div>

    <div class="background"></div>
    
    <main class="content">
        <h1 class="title">员工服务系统</h1>
        <div class="nav-cards">
            <div class="nav-card" data-href="dorm-rules.html">
                <h2>宿舍管理</h2>
                <p>管理制度查询</p>
            </div>
            <div class="nav-card" data-href="fee-query.html">
                <h2>费用查询</h2>
                <p>电费查询服务</p>
            </div>
        </div>
    </main>

    <script>
        // 初始化性能监控
        performance.mark('initStart');
        
        // 环境检测
        const isMobile = /Mobi|Android/i.test(navigator.userAgent);
        const isWeChat = /MicroMessenger/i.test(navigator.userAgent);
        
        // 网络检测
        const connection = navigator.connection || navigator.mozConnection;
        let effectiveType = connection?.effectiveType || '4g';
        document.documentElement.dataset.network = effectiveType;

        // 动态加载策略
        function loadAssets() {
            const loadPromises = [];
            
            // 按需加载图片
            const bg = document.querySelector('.background');
            const img = new Image();
            img.src = effectiveType === '4g' ? 'bg.avif' : 'bg-low.webp';
            img.decode().then(() => {
                bg.style.backgroundImage = `url(${img.src})`;
            }).catch(console.error);

            // 加载非关键JS
            if(effectiveType !== '2g') {
                loadPromises.push(
                    import('./app.js').catch(e => 
                        import('./lite.js'))
                );
            }

            return Promise.all(loadPromises);
        }

        // Service Worker注册
        if('serviceWorker' in navigator) {
            const swTimeout = setTimeout(() => {
                console.warn('SW安装超时');
            }, 5000);

            navigator.serviceWorker.register('/sw.js', {
                updateViaCache: 'none',
                scope: '/'
            }).then(reg => {
                clearTimeout(swTimeout);
                reg.addEventListener('updatefound', () => {
                    const newWorker = reg.installing;
                    newWorker.addEventListener('statechange', () => {
                        if(newWorker.state === 'activated') {
                            document.getElementById('updateNotice').hidden = false;
                        }
                    });
                });
            }).catch(console.error);
        }

        // 错误监控
        window.addEventListener('error', e => {
            const errorData = {
                msg: e.message,
                stack: e.error?.stack,
                href: location.href,
                network: effectiveType
            };
            navigator.sendBeacon('/log/error', JSON.stringify(errorData));
        });

        // 性能上报
        window.addEventListener('load', () => {
            performance.mark('initEnd');
            performance.measure('initTime', 'initStart', 'initEnd');
            
            const [measure] = performance.getEntriesByName('initTime');
            navigator.sendBeacon('/log/perf', JSON.stringify({
                type: 'load',
                duration: measure.duration,
                dcl: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart,
                network: effectiveType
            }));
        });

        // 启动加载
        document.getElementById('loader').style.display = 'grid';
        loadAssets().finally(() => {
            document.getElementById('loader').style.display = 'none';
        });
    </script>
</body>
</html>
