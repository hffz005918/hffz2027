<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 强化缓存和网络控制 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    <title>员工服务系统 - 网络诊断</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            background: linear-gradient(135deg, #6a8bad 0%, #4a6b8f 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 2rem;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            color: #333;
        }
        
        h1 {
            color: #1890ff;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .status-item {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            background: #f5f5f5;
        }
        
        .status-good {
            border-left: 4px solid #52c41a;
        }
        
        .status-bad {
            border-left: 4px solid #ff4d4f;
        }
        
        .status-warning {
            border-left: 4px solid #faad14;
        }
        
        .btn {
            background: #1890ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            width: 100%;
        }
        
        .btn:hover {
            background: #40a9ff;
        }
        
        .btn-retry {
            background: #52c41a;
        }
        
        .btn-copy {
            background: #722ed1;
        }
        
        .hidden {
            display: none;
        }
        
        #diagnosisResult {
            margin-top: 1rem;
            padding: 1rem;
            background: #e6f7ff;
            border-radius: 6px;
            border-left: 4px solid #1890ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>网络连接诊断</h1>
        
        <div class="status-item" id="networkStatus">
            <h3>网络连接状态</h3>
            <p>检测中...</p>
        </div>
        
        <div class="status-item" id="wechatStatus">
            <h3>微信浏览器兼容性</h3>
            <p>检测中...</p>
        </div>
        
        <div class="status-item" id="serverStatus">
            <h3>服务器连接状态</h3>
            <p>检测中...</p>
        </div>
        
        <div id="diagnosisResult" class="hidden"></div>
        
        <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-retry" onclick="retryConnection()">重新检测连接</button>
            <button class="btn" onclick="showSolutions()">显示解决方案</button>
            <button class="btn btn-copy" onclick="copyUrl()">复制页面链接</button>
            <button class="btn" onclick="openInBrowser()">在浏览器中打开</button>
        </div>
    </div>

    <script>
        // 版本控制
        const APP_VERSION = '20241001';
        
        // 环境检测
        const isWeChat = /micromessenger/i.test(navigator.userAgent);
        const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        // 微信专用错误处理
        if (isWeChat) {
            window.addEventListener('error', function(e) {
                console.error('微信环境错误:', e);
                updateStatus('wechatStatus', 'error', '微信环境中存在兼容性问题');
            });
        }
        
        // 网络诊断功能
        function diagnoseNetwork() {
            updateStatus('networkStatus', 'checking', '检测网络连接...');
            updateStatus('wechatStatus', 'checking', '检测微信兼容性...');
            updateStatus('serverStatus', 'checking', '检测服务器连接...');
            
            // 检测网络连接
            checkNetworkConnection();
            
            // 检测微信环境
            checkWechatEnvironment();
            
            // 检测服务器连接
            checkServerConnection();
        }
        
        function checkNetworkConnection() {
            if (!navigator.onLine) {
                updateStatus('networkStatus', 'error', '设备处于离线状态');
                return;
            }
            
            // 尝试访问几个常用网站测试网络
            const testUrls = [
                'https://www.qq.com/',
                'https://www.baidu.com/',
                'https://www.taobao.com/'
            ];
            
            let connected = false;
            let testCount = 0;
            
            testUrls.forEach(url => {
                fetch(url, { 
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-cache'
                }).then(() => {
                    connected = true;
                    testCount++;
                    if (testCount === 1) { // 只要有一个成功就认为网络正常
                        updateStatus('networkStatus', 'good', '网络连接正常');
                    }
                }).catch(() => {
                    testCount++;
                    if (testCount === testUrls.length && !connected) {
                        updateStatus('networkStatus', 'error', '网络连接异常，可能被限制');
                    }
                });
            });
            
            // 超时处理
            setTimeout(() => {
                const statusElement = document.getElementById('networkStatus');
                if (statusElement.querySelector('p').textContent.includes('检测中')) {
                    updateStatus('networkStatus', 'warning', '网络检测超时，连接可能较慢');
                }
            }, 5000);
        }
        
        function checkWechatEnvironment() {
            if (!isWeChat) {
                updateStatus('wechatStatus', 'good', '非微信环境，兼容性良好');
                return;
            }
            
            // 微信环境检测
            const wechatVersion = navigator.userAgent.match(/MicroMessenger\/([\d.]+)/i);
            const version = wechatVersion ? wechatVersion[1] : '未知';
            
            // 检测微信JSBridge
            if (typeof WeixinJSBridge !== 'undefined') {
                updateStatus('wechatStatus', 'good', `微信版本 ${version}，JSBridge 可用`);
            } else {
                updateStatus('wechatStatus', 'warning', `微信版本 ${version}，部分功能可能受限`);
            }
            
            // 检测常见微信限制
            testWechatLimitations();
        }
        
        function testWechatLimitations() {
            // 测试本地存储
            try {
                localStorage.setItem('test', 'value');
                localStorage.removeItem('test');
            } catch (e) {
                updateStatus('wechatStatus', 'warning', '本地存储可能被限制');
            }
            
            // 测试Cookie
            try {
                document.cookie = 'test=value; path=/';
                const hasCookie = document.cookie.indexOf('test=') !== -1;
                if (!hasCookie) {
                    updateStatus('wechatStatus', 'warning', 'Cookie 可能被限制');
                }
            } catch (e) {
                // Cookie设置失败
            }
        }
        
        function checkServerConnection() {
            // 尝试连接当前域名
            const currentDomain = window.location.origin;
            
            fetch(currentDomain + '/?t=' + Date.now(), {
                method: 'HEAD',
                cache: 'no-cache',
                mode: 'same-origin'
            }).then(response => {
                if (response.status === 200) {
                    updateStatus('serverStatus', 'good', '服务器连接正常');
                } else {
                    updateStatus('serverStatus', 'error', `服务器返回状态: ${response.status}`);
                }
            }).catch(error => {
                console.error('服务器连接错误:', error);
                
                if (error.name === 'TypeError') {
                    updateStatus('serverStatus', 'error', '域名解析失败或跨域限制');
                } else if (error.name === 'NetworkError') {
                    updateStatus('serverStatus', 'error', '网络错误，可能被防火墙拦截');
                } else {
                    updateStatus('serverStatus', 'error', '连接失败: ' + error.message);
                }
            });
            
            // 超时处理
            setTimeout(() => {
                const statusElement = document.getElementById('serverStatus');
                if (statusElement.querySelector('p').textContent.includes('检测中')) {
                    updateStatus('serverStatus', 'error', '服务器连接超时');
                }
            }, 10000);
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            const statusElement = element.querySelector('p');
            
            // 移除旧的状态类
            element.classList.remove('status-good', 'status-bad', 'status-warning');
            
            // 添加新的状态类
            switch(status) {
                case 'good':
                    element.classList.add('status-good');
                    break;
                case 'error':
                    element.classList.add('status-bad');
                    break;
                case 'warning':
                    element.classList.add('status-warning');
                    break;
            }
            
            statusElement.textContent = message;
        }
        
        function retryConnection() {
            diagnoseNetwork();
        }
        
        function showSolutions() {
            const resultDiv = document.getElementById('diagnosisResult');
            let solutions = '';
            
            if (isWeChat) {
                solutions = `
                    <h4>微信浏览器访问问题解决方案：</h4>
                    <ol>
                        <li><strong>方法一：刷新页面</strong> - 下拉页面触发刷新</li>
                        <li><strong>方法二：复制链接</strong> - 点击右上角复制链接，在浏览器中打开</li>
                        <li><strong>方法三：清理缓存</strong> - 微信设置 → 通用 → 存储空间 → 清理缓存</li>
                        <li><strong>方法四：更新微信</strong> - 确保使用最新版微信</li>
                        <li><strong>方法五：更换网络</strong> - 尝试切换WiFi/移动数据</li>
                    </ol>
                    <p><strong>重要提示：</strong>如果域名未备案或使用境外服务器，可能在微信中受限。</p>
                `;
            } else {
                solutions = `
                    <h4>网络连接问题解决方案：</h4>
                    <ol>
                        <li>检查网络连接是否正常</li>
                        <li>尝试刷新页面 (F5 或 Ctrl+R)</li>
                        <li>清除浏览器缓存和Cookie</li>
                        <li>尝试使用其他浏览器</li>
                        <li>联系网络管理员检查防火墙设置</li>
                    </ol>
                `;
            }
            
            resultDiv.innerHTML = solutions;
            resultDiv.classList.remove('hidden');
        }
        
        function copyUrl() {
            const url = window.location.href;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('链接已复制到剪贴板');
                }).catch(() => {
                    fallbackCopy(url);
                });
            } else {
                fallbackCopy(url);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('链接已复制到剪贴板');
            } catch (err) {
                alert('复制失败，请手动复制链接: ' + text);
            }
            
            document.body.removeChild(textArea);
        }
        
        function openInBrowser() {
            if (isWeChat) {
                // 微信中提示用户手动打开
                const url = window.location.href;
                alert(`请在浏览器中打开以下链接：\n\n${url}\n\n点击"复制页面链接"按钮后，粘贴到浏览器中访问。`);
            } else {
                // 非微信环境直接尝试打开
                window.open(window.location.href, '_blank');
            }
        }
        
        // 页面加载完成后开始诊断
        document.addEventListener('DOMContentLoaded', function() {
            diagnoseNetwork();
            
            // 监听网络状态变化
            window.addEventListener('online', function() {
                updateStatus('networkStatus', 'good', '网络已恢复连接');
            });
            
            window.addEventListener('offline', function() {
                updateStatus('networkStatus', 'error', '网络连接已断开');
            });
        });
        
        // 微信JSBridge就绪处理
        if (isWeChat) {
            document.addEventListener('WeixinJSBridgeReady', function() {
                updateStatus('wechatStatus', 'good', '微信JSBridge已就绪');
            });
        }
    </script>
</body>
</html>