<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 微信专属Viewport配置 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    <!-- 动态CDN选择 -->
    <link rel="dns-prefetch" href="//res.yourdomain.com" id="dns-prefetch">
    <link rel="preconnect" href="https://res.yourdomain.com" id="preconnect">
    
    <!-- 微信优化标签 -->
    <meta name="referrer" content="never">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="x5-page-mode" content="app">
    <meta name="x5-orientation" content="portrait">
    <meta name="renderer" content="webkit">
    
    <!-- SEO优化 -->
    <meta name="description" content="宏方纺织员工服务平台，提供宿舍管理、费用查询等服务">
    <title>员工服务系统 - 宏方纺织</title>

    <!-- 关键CSS内联 -->
    <style>
        :root {
            --primary-color: #1890ff;
            --secondary-color: #1a73e8;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-light: #ffffff;
            --text-dark: #333333;
            --text-secondary: #666666;
            --transition-speed: 0.3s;
            --border-radius: 12px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --box-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            font-family: -apple-system, "Microsoft YaHei", "PingFang SC", sans-serif;
            height: 100vh;
            background: linear-gradient(135deg, #6a8bad 0%, #4a6b8f 100%);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* 首屏关键样式 */
        .wechat-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 1rem;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 其他样式将在DOM加载后通过JavaScript注入 */
    </style>
</head>
<body>
    <!-- 微信加载提示 -->
    <div class="wechat-loader" id="wechatLoader" aria-live="polite">
        <div class="loader-spinner"></div>
        <div class="loader-content" id="loaderText">系统初始化中...</div>
    </div>

    <!-- 首页欢迎弹窗 -->
    <div class="welcome-modal" id="welcomeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>欢迎使用员工服务系统</h2>
            </div>
            <div class="modal-body">
                <p>尊敬的宏方纺织员工：</p>
                <p>夏季用电高峰来临，为保障安全，现就宿舍用电及烹饪规定通知如下：</p>
                <p>1.用电安全：严禁使用热得快、电炒锅等大功率违规电器；人走断电，勿私拉电线；发现用电设施故障及时报修。</p>
                <p>2.禁止烹饪：宿舍内不得使用电饭煲、电磁炉等任何炊具烧菜做饭，存在火灾等严重安全隐患。</p>
                <br>
                <p>违反上述规定，将没收违规物品，首次违规通报批评，多次违规取消评优资格，违规行为影响年终评定，情节严重给予纪律处分。欢迎大家互相监督举报。</p>
                <br>
                <p>请严格遵守，共同维护宿舍安全！</p>      
                <p style="margin-top: 1rem;">如有任何问题，请与办公室联系。</p>
            </div>
            <div class="modal-footer">
                <button class="close-btn" id="closeModalBtn">我知道了</button>
            </div>
        </div>
    </div>

    <!-- 渐进式背景加载 -->
    <div class="background" id="background"></div>
    
    <div class="content" id="mainContent" style="display: none;">
        <div class="title">
            <h1>员工服务系统</h1>
            <p>欢迎使用宏方纺织服务平台</p>
        </div>
        
        <div class="nav-cards" role="navigation">
            <div class="nav-card" 
                 role="button" 
                 tabindex="0"
                 data-href="dorm-rules.html"
                 aria-labelledby="dorm-title"
                 aria-describedby="dorm-desc">
                <h2 id="dorm-title">宿舍管理</h2>
                <p id="dorm-desc">员工宿舍管理制度</p>
            </div>
            
            <div class="nav-card" 
                 role="button" 
                 tabindex="0"
                 data-href="fee-query.html"
                 aria-labelledby="fee-title"
                 aria-describedby="fee-desc">
                <h2 id="fee-title">费用查询</h2>
                <p id="fee-desc">水电费用查询服务</p>
            </div>
        </div>
    </div>

    <script>
    (function() {
        // ==================== 环境检测 ====================
        const isWeChat = () => {
            const ua = navigator.userAgent.toLowerCase();
            return /micromessenger/.test(ua) || 
                   window.__wxjs_environment === 'miniprogram' ||
                   typeof WeixinJSBridge !== 'undefined';
        };

        // ==================== 微信Bridge初始化 ====================
        const initWeChatBridge = () => {
            return new Promise((resolve) => {
                if (!isWeChat()) return resolve();

                // 方案1：直接检测Bridge
                if (typeof WeixinJSBridge !== 'undefined') {
                    setupWeChatFeatures();
                    return resolve();
                }

                // 方案2：事件监听
                const readyHandler = () => {
                    document.removeEventListener('WeixinJSBridgeReady', readyHandler);
                    clearTimeout(timeout);
                    setupWeChatFeatures();
                    resolve();
                };

                document.addEventListener('WeixinJSBridgeReady', readyHandler, { once: true });

                // 超时处理
                const timeout = setTimeout(() => {
                    document.removeEventListener('WeixinJSBridgeReady', readyHandler);
                    console.warn('微信Bridge初始化超时');
                    resolve();
                }, 1500);
            });
        };

        const setupWeChatFeatures = () => {
            try {
                // 字体大小控制
                WeixinJSBridge?.invoke('setFontSizeCallback', { fontSize: 0 });
                WeixinJSBridge?.on('menu:setfont', () => {
                    WeixinJSBridge.invoke('setFontSizeCallback', { fontSize: 0 });
                });

                // 禁用长按菜单
                document.addEventListener('contextmenu', (e) => e.preventDefault());
            } catch (e) {
                console.warn('微信功能设置失败:', e);
            }
        };

        // ==================== 核心应用 ====================
        const App = {
            // 初始化入口
            async init() {
                try {
                    // 微信环境优先初始化
                    if (isWeChat()) {
                        updateLoaderText('正在准备微信环境...');
                        await initWeChatBridge();
                        this.setupWeChatCDN();
                    }

                    // 并行执行初始化任务
                    await Promise.all([
                        this.loadCriticalResources(),
                        this.setupModal(),
                        this.injectNonCriticalCSS()
                    ]);

                    // 显示内容
                    this.showMainContent();
                } catch (error) {
                    console.error('初始化失败:', error);
                    updateLoaderText('系统初始化失败，请刷新重试');
                    this.showEmergencyContent();
                }
            },

            // 加载关键资源
            async loadCriticalResources() {
                const bgUrl = await this.getOptimalBackgroundUrl();
                await this.loadBackground(bgUrl);
            },

            // 获取最优背景图URL
            async getOptimalBackgroundUrl() {
                const isMobile = window.innerWidth < 768;
                const supportsWebP = await this.checkWebPSupport();
                const baseUrl = 'https://res.yourdomain.com/images/';

                let filename;
                if (isMobile) {
                    filename = supportsWebP ? 'bg-mobile.webp' : 'bg-mobile.jpg';
                } else {
                    filename = supportsWebP ? 'bg-desktop.webp' : 'bg-desktop.jpg';
                }

                return baseUrl + filename + (isWeChat() ? `?t=${Date.now()}` : '');
            },

            // 检测WebP支持
            checkWebPSupport() {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(img.width > 0 && img.height > 0);
                    img.onerror = () => resolve(false);
                    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
                });
            },

            // 加载背景图
            loadBackground(url) {
                return new Promise((resolve) => {
                    const bg = document.getElementById('background');
                    const img = new Image();

                    img.onload = () => {
                        bg.style.backgroundImage = `url('${url}')`;
                        bg.classList.add('loaded');
                        resolve();
                    };

                    img.onerror = () => {
                        console.log('背景图加载失败，使用CSS渐变');
                        bg.style.display = 'none';
                        resolve();
                    };

                    img.src = url;
                });
            },

            // 设置微信专用CDN
            setupWeChatCDN() {
                if (!isWeChat()) return;

                const cdnDomain = 'https://wechat-cdn.yourdomain.com';
                document.getElementById('dns-prefetch').href = cdnDomain;
                document.getElementById('preconnect').href = cdnDomain;
            },

            // 注入非关键CSS
            injectNonCriticalCSS() {
                return new Promise(resolve => {
                    const style = document.createElement('style');
                    style.textContent = `
                        .background {
                            position: fixed;
                            width: 100%;
                            height: 100%;
                            background: no-repeat center/cover;
                            filter: brightness(0.8);
                            z-index: -1;
                            opacity: 0;
                            transition: opacity 0.8s ease;
                        }
                        .background.loaded { opacity: 1; }
                        
                        .content {
                            height: 100%;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            padding: 20px;
                        }
                        
                        .title {
                            color: var(--text-light);
                            text-align: center;
                            margin-bottom: 3rem;
                            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                        }
                        
                        .title h1 {
                            font-size: clamp(1.8rem, 5vw, 2.5rem);
                            margin-bottom: 0.8rem;
                            font-weight: 500;
                        }
                        
                        .title p {
                            font-size: clamp(1rem, 3vw, 1.2rem);
                            opacity: 0.9;
                        }
                        
                        .nav-cards {
                            display: grid;
                            gap: 1.5rem;
                            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                            width: min(90%, 800px);
                            margin: 0 auto;
                        }
                        
                        .nav-card {
                            background: var(--card-bg);
                            padding: 2rem;
                            border-radius: var(--border-radius);
                            cursor: pointer;
                            transition: 
                                transform var(--transition-speed) ease,
                                box-shadow var(--transition-speed) ease;
                            box-shadow: var(--box-shadow);
                            backdrop-filter: blur(5px);
                            -webkit-backdrop-filter: blur(5px);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                            outline: none;
                        }
                        
                        .nav-card:focus-visible {
                            box-shadow: 0 0 0 3px var(--secondary-color);
                        }
                        
                        .nav-card:hover {
                            transform: translateY(-5px);
                            box-shadow: var(--box-shadow-hover);
                        }
                        
                        .nav-card:active {
                            transform: translateY(-2px) scale(0.98);
                        }
                        
                        .nav-card h2 {
                            color: var(--primary-color);
                            margin-bottom: 1rem;
                            font-size: clamp(1.3rem, 4vw, 1.6rem);
                            font-weight: 500;
                        }
                        
                        .nav-card p {
                            color: var(--text-secondary);
                            font-size: clamp(0.9rem, 3vw, 1rem);
                        }
                        
                        .welcome-modal {
                            display: none;
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.7);
                            z-index: 1001;
                            justify-content: center;
                            align-items: center;
                            backdrop-filter: blur(5px);
                            -webkit-backdrop-filter: blur(5px);
                        }
                        
                        .modal-content {
                            background: var(--card-bg);
                            width: min(90%, 500px);
                            padding: 2rem;
                            border-radius: var(--border-radius);
                            box-shadow: var(--box-shadow-hover);
                            position: relative;
                            animation: fadeIn 0.3s ease-out;
                        }
                        
                        .modal-header h2 {
                            color: var(--primary-color);
                            font-size: 1.5rem;
                            margin-bottom: 0.5rem;
                        }
                        
                        .modal-body {
                            color: var(--text-dark);
                            margin-bottom: 2rem;
                            line-height: 1.6;
                        }
                        
                        .close-btn {
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 0.6rem 1.2rem;
                            border-radius: var(--border-radius);
                            cursor: pointer;
                            font-size: 1rem;
                            transition: background-color 0.2s ease;
                        }
                        
                        .close-btn:hover {
                            background: var(--secondary-color);
                        }
                        
                        @keyframes fadeIn {
                            from { opacity: 0; transform: translateY(-20px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        
                        /* 响应式调整 */
                        @media (max-width: 768px) {
                            .nav-cards { width: 95%; }
                            .nav-card { padding: 1.5rem; }
                        }
                        
                        @media (max-width: 480px) {
                            .nav-cards { grid-template-columns: 1fr; }
                        }
                    `;
                    document.head.appendChild(style);
                    resolve();
                });
            },

            // 弹窗设置
            setupModal() {
                return new Promise(resolve => {
                    const modal = document.getElementById('welcomeModal');
                    const closeBtn = document.getElementById('closeModalBtn');
                    
                    // 延迟显示确保体验流畅
                    setTimeout(() => {
                        modal.style.display = 'flex';
                        resolve();
                    }, 800);
                    
                    closeBtn.addEventListener('click', () => {
                        modal.style.display = 'none';
                    });
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.style.display = 'none';
                    });
                    
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') modal.style.display = 'none';
                    });
                });
            },

            // 显示主内容
            showMainContent() {
                document.getElementById('mainContent').style.display = 'flex';
                this.bindEvents();
                setTimeout(() => {
                    document.getElementById('wechatLoader').style.display = 'none';
                }, 300);
            },

            // 应急内容显示
            showEmergencyContent() {
                document.getElementById('mainContent').innerHTML = `
                    <div style="color: white; text-align: center; padding: 20px;">
                        <h2>系统暂时不可用</h2>
                        <p>请检查网络连接后刷新页面</p>
                        <button onclick="window.location.reload()" style="
                            background: var(--primary-color);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            margin-top: 20px;
                            cursor: pointer;
                        ">刷新页面</button>
                    </div>
                `;
                document.getElementById('mainContent').style.display = 'flex';
            },

            // 事件绑定
            bindEvents() {
                // 卡片点击处理
                document.querySelectorAll('.nav-card').forEach(card => {
                    const handleAction = () => {
                        const url = this.cacheBust(card.dataset.href);
                        updateLoaderText('正在跳转...');
                        
                        // 微信环境下预加载目标页面
                        if (isWeChat()) {
                            this.preloadPage(url);
                        }
                        
                        // 延迟跳转确保体验
                        setTimeout(() => {
                            window.location.href = url;
                        }, 300);
                    };
                    
                    card.addEventListener('click', handleAction);
                    card.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            handleAction();
                        }
                    });
                });
            },

            // 缓存处理
            cacheBust(url) {
                return isWeChat() ? `${url}?t=${Date.now()}` : url;
            },

            // 页面预加载
            preloadPage(url) {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = url;
                document.head.appendChild(link);
            }
        };

        // ==================== 辅助函数 ====================
        function updateLoaderText(text) {
            const el = document.getElementById('loaderText');
            if (el) el.textContent = text;
        }

        // ==================== 启动应用 ====================
        // 微信环境下8秒超时提示
        if (isWeChat()) {
            setTimeout(() => {
                const loader = document.getElementById('wechatLoader');
                if (loader && loader.style.display === 'flex') {
                    updateLoaderText('如长时间无响应，请检查网络后刷新');
                }
            }, 8000);
        }

        // 安全启动
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => App.init(), 0);
        });

        // 微信环境下提前执行
        if (isWeChat() && document.readyState === 'complete') {
            App.init();
        }
    })();
    </script>
</body>
</html>