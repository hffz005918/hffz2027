// jsonbin-storage-auto.js - è‡ªåŠ¨ç”ŸæˆBin IDçš„å®Œæ•´ç‰ˆæœ¬
class JsonBinStorage {
    constructor() {
        // è‡ªåŠ¨ç”ŸæˆBin IDå¹¶åˆå§‹åŒ–å­˜å‚¨
        this.binId = this.loadBinIdFromStorage() || 'æœªé…ç½®';
        this.initialized = false;
        
        // API Keys
        this.readOnlyKey = '$2a$10$AOxCSd1PIW2XUkxQvRpVVeimltcnLXIoOlqvBvFJwlxCihUD2wope';
        this.masterKey = '$2a$10$AOxCSd1PIW2XUkxQvRpVVeimltcnLXIoOlqvBvFJwlxCihUD2wope';
        
        this.baseUrl = 'https://api.jsonbin.io/v3/b';
        this.apiBaseUrl = 'https://api.jsonbin.io/v3';
        
        console.log('ðŸ”„ JSONBinå­˜å‚¨åˆå§‹åŒ–ï¼Œå½“å‰Bin ID:', this.binId);
    }
    
    /**
     * ä»Žæœ¬åœ°å­˜å‚¨åŠ è½½Bin ID
     */
    loadBinIdFromStorage() {
        try {
            return localStorage.getItem('jsonbin_bin_id');
        } catch (error) {
            console.warn('æ— æ³•è®¿é—®æœ¬åœ°å­˜å‚¨:', error);
            return null;
        }
    }
    
    /**
     * ä¿å­˜Bin IDåˆ°æœ¬åœ°å­˜å‚¨
     */
    saveBinIdToStorage(binId) {
        try {
            localStorage.setItem('jsonbin_bin_id', binId);
            return true;
        } catch (error) {
            console.warn('æ— æ³•ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨:', error);
            return false;
        }
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„Bin
     */
    async checkAndCreateBinIfNeeded() {
        // å¦‚æžœå·²ç»æœ‰Bin IDï¼ŒéªŒè¯å®ƒæ˜¯å¦æœ‰æ•ˆ
        if (this.binId && this.binId !== 'æœªé…ç½®') {
            const testResult = await this.testConnection();
            if (testResult.connected) {
                console.log('âœ… ä½¿ç”¨çŽ°æœ‰Bin ID:', this.binId);
                this.initialized = true;
                return {
                    success: true,
                    message: `ä½¿ç”¨çŽ°æœ‰Bin: ${this.binId}`,
                    binId: this.binId,
                    existing: true
                };
            }
            
            console.warn('çŽ°æœ‰Bin IDæ— æ•ˆï¼Œå°†åˆ›å»ºæ–°Bin');
        }
        
        // åˆ›å»ºæ–°Bin
        return await this.createAndSetupNewBin();
    }
    
    /**
     * è‡ªåŠ¨åˆ›å»ºå’Œé…ç½®æ–°çš„Bin
     */
    async createAndSetupNewBin() {
        console.log('ðŸ”„ æ­£åœ¨åˆ›å»ºæ–°çš„JSONBinå­˜å‚¨...');
        
        try {
            // 1. åˆ›å»ºæ–°çš„Bin
            const createResponse = await fetch(`${this.apiBaseUrl}/b`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': this.masterKey,
                    'X-Bin-Private': 'false'
                },
                body: JSON.stringify({
                    feedbacks: [],
                    stats: {
                        total: 0,
                        pending: 0,
                        processed: 0,
                        suggestions: 0,
                        problems: 0,
                        complaints: 0,
                        others: 0
                    },
                    system: {
                        created: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        version: '1.0'
                    },
                    meta: {
                        description: 'å‘˜å·¥åé¦ˆç®¡ç†ç³»ç»Ÿ',
                        version: '1.0',
                        autoGenerated: true
                    }
                })
            });
            
            if (!createResponse.ok) {
                throw new Error(`åˆ›å»ºå¤±è´¥: HTTP ${createResponse.status}`);
            }
            
            const createData = await createResponse.json();
            const newBinId = createData.metadata.id;
            
            console.log('âœ… æˆåŠŸåˆ›å»ºæ–°Bin:', newBinId);
            
            // 2. æ›´æ–°Bin ID
            this.binId = newBinId;
            this.saveBinIdToStorage(newBinId);
            
            // 3. éªŒè¯åˆ›å»º
            const verifyResponse = await fetch(`${this.baseUrl}/${newBinId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': this.readOnlyKey
                }
            });
            
            if (!verifyResponse.ok) {
                throw new Error('éªŒè¯Binåˆ›å»ºå¤±è´¥');
            }
            
            const verifyData = await verifyResponse.json();
            console.log('âœ… BinéªŒè¯æˆåŠŸ:', verifyData.record?.meta?.description || 'æ–°Bin');
            
            this.initialized = true;
            
            return {
                success: true,
                message: 'âœ… æ–°Binåˆ›å»ºå¹¶é…ç½®æˆåŠŸ!',
                binId: newBinId,
                existing: false,
                record: verifyData.record
            };
            
        } catch (error) {
            console.error('âŒ åˆ›å»ºBinå¤±è´¥:', error);
            return {
                success: false,
                message: `åˆ›å»ºå¤±è´¥: ${error.message}`,
                binId: null
            };
        }
    }
    
    /**
     * æµ‹è¯•è¿žæŽ¥
     */
    async testConnection() {
        if (!this.binId || this.binId === 'æœªé…ç½®') {
            return {
                connected: false,
                message: 'âŒ Bin IDæœªé…ç½®'
            };
        }
        
        try {
            const response = await fetch(`${this.baseUrl}/${this.binId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': this.readOnlyKey
                }
            });
            
            if (response.status === 404) {
                return {
                    connected: false,
                    message: `âŒ Bin ${this.binId} ä¸å­˜åœ¨`
                };
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            const count = data.record?.feedbacks?.length || 0;
            
            return {
                connected: true,
                message: `âœ… è¿žæŽ¥æˆåŠŸ (${count}æ¡åé¦ˆ)`,
                binId: this.binId,
                feedbackCount: count,
                record: data.record
            };
            
        } catch (error) {
            return {
                connected: false,
                message: `âŒ è¿žæŽ¥å¤±è´¥: ${error.message}`,
                binId: this.binId
            };
        }
    }
    
    /**
     * åˆå§‹åŒ–å­˜å‚¨ç³»ç»Ÿï¼ˆè‡ªåŠ¨æ£€æµ‹æˆ–åˆ›å»ºBinï¼‰
     */
    async initialize() {
        if (this.initialized) {
            return {
                success: true,
                message: 'å­˜å‚¨ç³»ç»Ÿå·²åˆå§‹åŒ–',
                binId: this.binId
            };
        }
        
        console.log('ðŸ”„ åˆå§‹åŒ–JSONBinå­˜å‚¨ç³»ç»Ÿ...');
        return await this.checkAndCreateBinIfNeeded();
    }
    
    /**
     * èŽ·å–æ‰€æœ‰åé¦ˆ
     */
    async getFeedbacks() {
        if (!this.initialized) {
            const initResult = await this.initialize();
            if (!initResult.success) {
                console.warn('åˆå§‹åŒ–å¤±è´¥ï¼Œè¿”å›žç©ºæ•°ç»„');
                return [];
            }
        }
        
        try {
            const response = await fetch(`${this.baseUrl}/${this.binId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': this.readOnlyKey
                }
            });
            
            if (!response.ok) {
                console.warn('èŽ·å–å¤±è´¥ï¼Œè¿”å›žç©ºæ•°ç»„');
                return [];
            }
            
            const data = await response.json();
            return data.record?.feedbacks || [];
            
        } catch (error) {
            console.error('èŽ·å–åé¦ˆå¤±è´¥:', error);
            return [];
        }
    }
    
    /**
     * ä¿å­˜åé¦ˆ
     */
    async saveFeedback(feedbackData) {
        if (!this.initialized) {
            const initResult = await this.initialize();
            if (!initResult.success) {
                return {
                    success: false,
                    message: 'å­˜å‚¨ç³»ç»Ÿæœªåˆå§‹åŒ–'
                };
            }
        }
        
        try {
            // 1. èŽ·å–å½“å‰æ•°æ®
            const getResponse = await fetch(`${this.baseUrl}/${this.binId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': this.readOnlyKey
                }
            });
            
            if (!getResponse.ok) {
                throw new Error('èŽ·å–å½“å‰æ•°æ®å¤±è´¥');
            }
            
            const getData = await getResponse.json();
            const record = getData.record;
            
            // 2. åˆ›å»ºæ–°åé¦ˆ
            const newFeedback = {
                id: 'fb_' + Date.now(),
                employeeName: feedbackData.employeeName || 'åŒ¿åå‘˜å·¥',
                type: feedbackData.type,
                content: feedbackData.content,
                images: feedbackData.images || [],
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            // 3. æ·»åŠ åˆ°æ•°ç»„
            if (!record.feedbacks) record.feedbacks = [];
            record.feedbacks.push(newFeedback);
            
            // 4. æ›´æ–°ç»Ÿè®¡
            if (!record.stats) {
                record.stats = {
                    total: 0,
                    pending: 0,
                    processed: 0,
                    suggestions: 0,
                    problems: 0,
                    complaints: 0,
                    others: 0
                };
            }
            
            record.stats.total = record.feedbacks.length;
            record.stats.pending = record.feedbacks.filter(f => f.status === 'pending').length;
            
            // æ ¹æ®ç±»åž‹æ›´æ–°ç»Ÿè®¡
            if (newFeedback.type === 'suggestion') record.stats.suggestions++;
            else if (newFeedback.type === 'problem') record.stats.problems++;
            else if (newFeedback.type === 'complaint') record.stats.complaints++;
            else if (newFeedback.type === 'other') record.stats.others++;
            
            // 5. æ›´æ–°ç³»ç»Ÿä¿¡æ¯
            if (!record.system) record.system = {};
            record.system.lastUpdated = new Date().toISOString();
            
            // 6. ä¿å­˜å›žäº‘ç«¯
            const saveResponse = await fetch(`${this.baseUrl}/${this.binId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': this.masterKey
                },
                body: JSON.stringify(record)
            });
            
            if (!saveResponse.ok) {
                throw new Error('ä¿å­˜å¤±è´¥: ' + saveResponse.status);
            }
            
            console.log('âœ… åé¦ˆä¿å­˜æˆåŠŸ:', newFeedback.id);
            
            return {
                success: true,
                id: newFeedback.id,
                message: 'åé¦ˆå·²æˆåŠŸä¿å­˜åˆ°äº‘ç«¯',
                binId: this.binId,
                feedback: newFeedback
            };
            
        } catch (error) {
            console.error('ä¿å­˜å¤±è´¥:', error);
            return {
                success: false,
                message: 'ä¿å­˜å¤±è´¥: ' + error.message
            };
        }
    }
    
    /**
     * èŽ·å–ç»Ÿè®¡
     */
    async getStats() {
        if (!this.initialized) {
            const initResult = await this.initialize();
            if (!initResult.success) {
                return this.getDefaultStats();
            }
        }
        
        try {
            const response = await fetch(`${this.baseUrl}/${this.binId}`, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': this.readOnlyKey
                }
            });
            
            if (!response.ok) {
                return this.getDefaultStats();
            }
            
            const data = await response.json();
            return data.record?.stats || this.getDefaultStats();
            
        } catch (error) {
            console.error('èŽ·å–ç»Ÿè®¡å¤±è´¥:', error);
            return this.getDefaultStats();
        }
    }
    
    /**
     * èŽ·å–é»˜è®¤ç»Ÿè®¡
     */
    getDefaultStats() {
        return {
            total: 0,
            pending: 0,
            processed: 0,
            suggestions: 0,
            problems: 0,
            complaints: 0,
            others: 0
        };
    }
    
    /**
     * é‡ç½®å­˜å‚¨ï¼ˆåˆ›å»ºæ–°çš„Binï¼‰
     */
    async resetStorage() {
        console.log('ðŸ”„ é‡ç½®å­˜å‚¨ï¼Œåˆ›å»ºæ–°Bin...');
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„Bin ID
        try {
            localStorage.removeItem('jsonbin_bin_id');
        } catch (error) {
            // å¿½ç•¥é”™è¯¯
        }
        
        // é‡ç½®çŠ¶æ€
        this.binId = 'æœªé…ç½®';
        this.initialized = false;
        
        // åˆ›å»ºæ–°Bin
        return await this.createAndSetupNewBin();
    }
    
    /**
     * èŽ·å–å­˜å‚¨çŠ¶æ€ä¿¡æ¯
     */
    async getStorageInfo() {
        const connectionStatus = await this.testConnection();
        const stats = await this.getStats();
        
        return {
            binId: this.binId,
            initialized: this.initialized,
            connectionStatus,
            stats,
            localStorageAvailable: this.testLocalStorage()
        };
    }
    
    /**
     * æµ‹è¯•æœ¬åœ°å­˜å‚¨æ˜¯å¦å¯ç”¨
     */
    testLocalStorage() {
        try {
            const testKey = '__storage_test__';
            localStorage.setItem(testKey, testKey);
            localStorage.removeItem(testKey);
            return true;
        } catch (error) {
            return false;
        }
    }
}

// å…¨å±€å®žä¾‹
const jsonBinStorage = new JsonBinStorage();

// è¾…åŠ©å‡½æ•°ï¼šä¸€é”®åˆå§‹åŒ–
async function initializeJsonBinStorage() {
    console.log('ðŸš€ å¼€å§‹åˆå§‹åŒ–JSONBinå­˜å‚¨...');
    const result = await jsonBinStorage.initialize();
    
    if (result.success) {
        console.log('âœ… JSONBinå­˜å‚¨åˆå§‹åŒ–æˆåŠŸ!');
        console.log(`ðŸ“¦ Bin ID: ${result.binId}`);
        if (result.existing) {
            console.log('ðŸ“Š ä½¿ç”¨çŽ°æœ‰Bin');
        } else {
            console.log('âœ¨ åˆ›å»ºäº†æ–°Bin');
        }
    } else {
        console.error('âŒ JSONBinå­˜å‚¨åˆå§‹åŒ–å¤±è´¥:', result.message);
    }
    
    return result;
}

// è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºå­˜å‚¨çŠ¶æ€
async function showStorageStatus() {
    const info = await jsonBinStorage.getStorageInfo();
    
    console.group('ðŸ“Š JSONBinå­˜å‚¨çŠ¶æ€');
    console.log('Bin ID:', info.binId);
    console.log('åˆå§‹åŒ–çŠ¶æ€:', info.initialized ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–');
    console.log('è¿žæŽ¥çŠ¶æ€:', info.connectionStatus.message);
    console.log('æœ¬åœ°å­˜å‚¨:', info.localStorageAvailable ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨');
    console.log('ç»Ÿè®¡ä¿¡æ¯:', info.stats);
    console.groupEnd();
    
    return info;
}

// è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼Œå–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨ï¼‰
// document.addEventListener('DOMContentLoaded', async () => {
//     // ç­‰å¾…é¡µé¢åŠ è½½å®ŒæˆåŽè‡ªåŠ¨åˆå§‹åŒ–
//     setTimeout(async () => {
//         await initializeJsonBinStorage();
//         await showStorageStatus();
//     }, 1000);
// });